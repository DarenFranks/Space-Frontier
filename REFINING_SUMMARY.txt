================================================================================
REFINING SYSTEM ANALYSIS - EXECUTIVE SUMMARY
================================================================================

PROJECT GOAL:
Enable players to refine resources from BOTH ship cargo AND station storage,
instead of ship cargo only.

================================================================================
CURRENT IMPLEMENTATION OVERVIEW
================================================================================

1. REFINING LOGIC (game_engine.py, lines 559-640)
   - Function: GameEngine.refine_ore(ore_id, quantity)
   - LIMITATION: Only checks player.ship_cargo for available ores
   - Uses: player.has_item() which explicitly checks ship_cargo only
   - Process: Remove raw ore -> Add refined resource -> Update stats

2. REFINING GUI (gui.py, lines 4437-4610)
   - show_refine_view(): Lists raw ores available for refining
     LIMITATION: Only iterates player.ship_cargo
     Shows location: "Ship Cargo" only
   - refine_ore_dialog(): Dialog for entering quantity to refine
     LIMITATION: max_qty = player.ship_cargo.get(ore_id, 0)

3. INVENTORY SYSTEM (player.py)
   - Data structure:
     * ship_cargo: Dict[str, int]          <- Direct access
     * station_inventories: Dict[location, Dict[item, qty]]  <- By location
   - Transfer methods ALREADY EXIST:
     * transfer_to_station(item_id, qty, location)
     * transfer_to_ship(item_id, qty, location)
     * get_station_inventory(location)
     * get_total_item_count(item_id)

================================================================================
WHAT SOURCES ORES FROM
================================================================================

CURRENT:  Only player.ship_cargo
TARGET:   player.ship_cargo + player.station_inventories[current_location]

NOTE: Station storage already has full implementation for transfers and access.
      The refining system simply needs to tap into it.

================================================================================
SOLUTION ARCHITECTURE
================================================================================

APPROACH: Automatic Multi-Source Refining (Recommended)
- Check ship cargo first (up to requested quantity)
- Draw from station at current location if ship insufficient
- Refined output always goes to ship cargo
- UI shows: "x50 (ship) + x30 (station) = 80 total"

CHANGES NEEDED: ~120 lines across 3 files

1. player.py (NEW METHOD)
   - Add: get_total_accessible_quantity(item_id)
   - Returns: ({location: qty}, total)
   - Lines: ~20 new lines after line 196

2. game_engine.py (MODIFY METHOD)
   - Change: refine_ore() logic
   - From: Check player.has_item() only
   - To: Check total across ship+station
   - Lines: ~50 modified lines (559-640)

3. gui.py (MODIFY METHOD)
   - Change: show_refine_view() 
   - From: Iterate ship_cargo only
   - To: Iterate ship_cargo + all station_inventories
   - Lines: ~30 modified lines (4437-4528)

4. gui.py (MODIFY METHOD)
   - Change: refine_ore_dialog()
   - From: max_qty from ship only
   - To: max_qty from all sources
   - Lines: ~20 modified lines (4530-4610)

================================================================================
FILES INVOLVED
================================================================================

ANALYSIS DOCUMENTS CREATED:
- REFINING_SYSTEM_ANALYSIS.md          (Full technical analysis)
- REFINING_IMPLEMENTATION_GUIDE.md     (Implementation flowcharts & steps)
- REFINING_CODE_SNIPPETS.md            (Ready-to-use code snippets)
- REFINING_SUMMARY.txt                 (This file)

SOURCE FILES TO MODIFY:
- /home/daren/Space_Frontier/game_engine.py     (1 method)
- /home/daren/Space_Frontier/gui.py             (2 methods)
- /home/daren/Space_Frontier/player.py          (1 new method)

================================================================================
KEY DATA STRUCTURES
================================================================================

Raw Resources (data.py):
- raw_voltium, raw_nexium, raw_chronite, raw_titanite, raw_synthcrystal,
  raw_darkwater, raw_neuralfiber, raw_quantum_dust

Refining Yields (data.py):
- common: 80-95%
- uncommon: 70-85%
- rare: 60-75%
- very_rare: 55-65%
- legendary: 50-60%

Player Inventory:
- ship_cargo: {item_id: quantity}
- station_inventories: {location_id: {item_id: quantity}}

Station Access (requires logistics_management skill level 5+ for remote stations):
- Always: Current location
- With skill: All locations with stored inventory

================================================================================
IMPLEMENTATION CHECKLIST
================================================================================

Phase 1: Add Helper Method
- [ ] Add get_total_accessible_quantity() to Player class (player.py after line 196)
- [ ] Test: Verify method returns correct totals

Phase 2: Update Core Logic
- [ ] Modify refine_ore() in GameEngine (game_engine.py lines 559-640)
- [ ] Change inventory check to use new helper method
- [ ] Add logic to source from ship first, then station
- [ ] Test: Verify ore removal from both sources

Phase 3: Update GUI Display
- [ ] Modify show_refine_view() (gui.py lines 4437-4528)
- [ ] Iterate both ship and station inventories
- [ ] Show source breakdown in UI
- [ ] Test: Verify all ores display with correct totals

Phase 4: Update Dialog
- [ ] Modify refine_ore_dialog() (gui.py lines 4530-4610)
- [ ] Show available qty from each source
- [ ] Accept quantities > ship cargo amount
- [ ] Test: Verify multi-source refining works

Phase 5: Integration Testing
- [ ] Refining with ship cargo only
- [ ] Refining with station storage only
- [ ] Refining with combined sources
- [ ] Cargo capacity validation with multi-source
- [ ] Stats/XP updates working correctly
- [ ] Edge case: Ore added/removed between view and refine

================================================================================
TESTING SCENARIOS
================================================================================

Test 1: Ship Cargo Only (Backward Compatibility)
- Player has 50x raw_voltium in ship
- Player has 0x raw_voltium in station
- Refine 30 units -> Should succeed (all from ship)

Test 2: Station Storage Only
- Player has 0x raw_voltium in ship
- Player has 50x raw_voltium in station
- Refine 30 units -> Should succeed (all from station)

Test 3: Multi-Source
- Player has 50x raw_voltium in ship
- Player has 50x raw_voltium in station
- Refine 80 units -> Should succeed (50 from ship + 30 from station)

Test 4: Insufficient Quantity
- Player has 30x raw_voltium total
- Refine 50 units -> Should fail with message showing total available

Test 5: Cargo Space Validation
- Player has 50x raw ore (high volume)
- Ship is almost full
- Refined output is compact -> May still fail if space insufficient
- Should show clear error message

================================================================================
HELPER METHODS ALREADY AVAILABLE
================================================================================

These methods support the new functionality without modification:

player.get_accessible_stations()
- Returns: [current_location, ...remote if logistics_management >= 5]
- Used to: Find all accessible locations

player.get_station_inventory(location_id)
- Returns: {item_id: quantity} for that location
- Used to: Access station storage data

player.get_total_item_count(item_id)
- Returns: Total count across ship and ALL accessible stations
- Used to: Check total availability (similar to new method)

player.transfer_to_station(item_id, qty, location)
- Moves items from ship to station
- Used by: Players to manage inventory

player.transfer_to_ship(item_id, qty, location)
- Moves items from station to ship
- Used by: Players to manage inventory

================================================================================
RISKS & MITIGATION
================================================================================

Risk 1: Station inventory modified during refinement dialog
- Mitigation: Recheck availability at refine time (already done)

Risk 2: Player moves location during dialog
- Mitigation: Use player.location when removing from station

Risk 3: Insufficient space in ship cargo for refined output
- Mitigation: Validate cargo space with refined output size before removal

Risk 4: Backwards compatibility issues
- Mitigation: Ship-only refining still works (just takes from ship)

Fallback: Add config flag ENABLE_MULTI_SOURCE_REFINING = True/False
- Can quickly disable feature if issues arise

================================================================================
WHAT'S NOT CHANGED
================================================================================

- Refining requirements (refinery service or mothership)
- Yield calculations (still RNG-based by rarity)
- Refined output location (always ship cargo)
- Stats tracking (resources_refined counter)
- XP rewards (based on refined quantity)
- Cargo capacity checks (still validated)
- Station access restrictions (logistics_management skill still required)

================================================================================
ESTIMATED EFFORT
================================================================================

Code Changes: ~4 hours
- Add helper method: 30 min
- Modify refine_ore(): 1 hour
- Update show_refine_view(): 1 hour
- Update refine_ore_dialog(): 45 min

Testing: ~2 hours
- Unit tests for helper method: 30 min
- Integration tests for all scenarios: 1.5 hours

Documentation: 2 hours (already done in analysis files)

Total: ~8 hours

================================================================================
SUCCESS CRITERIA
================================================================================

1. Players can refine ores from ship cargo
2. Players can refine ores from station storage (current location only)
3. Players can refine combined ore from both sources
4. GUI shows source breakdown (e.g., "30 ship + 20 station")
5. Refined output always goes to ship cargo
6. Cargo capacity is validated correctly
7. Stats and XP awards work correctly
8. No errors or edge case failures
9. Backwards compatibility maintained

================================================================================
NEXT STEPS
================================================================================

1. Review this analysis with team
2. Decide on implementation approach (Recommended: Option A - Automatic)
3. Follow REFINING_CODE_SNIPPETS.md for ready-to-use code
4. Implement in order: player.py -> game_engine.py -> gui.py
5. Test thoroughly using scenarios in TESTING SCENARIOS section
6. Update player documentation if needed
7. Consider expanding to other crafting systems (manufacturing, recycling)

================================================================================
